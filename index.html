<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Brigada Protectora VR - Menú 3D Fijo</title>
  <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
  <style>
    /* Fuente personalizada opcional */
    @font-face {
      font-family: 'RetroGaming';
      src: url('fonts/retro_gaming.ttf') format('truetype');
    }
    body, html {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      font-family: 'RetroGaming', sans-serif;
      overflow: hidden;
    }
    /* Estilos para feedback en pantalla (opcional) */
    .score-alert, .feedback-alert {
      position: fixed;
      right: 20px;
      padding: 10px;
      border-radius: 5px;
      z-index: 999;
      color: #fff;
      font-family: 'RetroGaming', sans-serif;
    }
    .score-alert {
      top: 20px;
      background: green;
    }
    .feedback-alert {
      bottom: 20px;
      background: rgba(0,0,0,0.7);
    }
  </style>
</head>
<body>

<a-scene renderer="antialias: true" 
         background="color: #000" 
         embedded
         vr-mode-ui="enabled: true"
         cursor="rayOrigin: mouse">

  <!-- Activos (imágenes, audios, etc.) -->
  <a-assets>
    <img id="skyImage" src="images/fondobonito.png">
    <audio id="bgMusicAsset" src="audio/bgMusic.mp3"></audio>
    <!-- Audios de ejemplo para narraciones, correctSound, wrongSound, etc. -->
    <audio id="correctSoundAsset" src="audio/correctSound.mp3"></audio>
    <audio id="wrongSoundAsset" src="audio/wrongSound.mp3"></audio>
    <audio id="clickSoundAsset" src="audio/clickSound.mp3"></audio>
    <audio id="introAsset" src="audio/intro.mp3"></audio>
    <!-- Podrías añadir más audios para cada nivel en assets -->
  </a-assets>

  <!-- Fondo -->
  <a-sky src="#skyImage" rotation="0 -130 0"></a-sky>

  <!-- Cámara y controles -->
  <a-entity id="cameraRig" position="0 1.6 0">
    <a-entity camera look-controls></a-entity>
  </a-entity>
  <!-- Controladores con láser para VR -->
  <a-entity laser-controls="hand: left" 
            raycaster="objects: .clickable; showLine: true;" 
            line="color: red">
  </a-entity>
  <a-entity laser-controls="hand: right" 
            raycaster="objects: .clickable; showLine: true;" 
            line="color: blue">
  </a-entity>

  <!-- MENÚ 3D FIJO, que gestiona todo el flujo (registro, intro, preguntas y final) -->
  <a-entity id="menu3d" position="0 1.6 -2">
    <!-- FONDO general para todo el menú -->
    <a-plane id="menuBg" width="2.5" height="2.8" color="#333" opacity="0.8"
             position="0 0 0"
             material="shader: flat">
    </a-plane>

    <!-- 1) REGISTRO DE PARTICIPANTE -->
    <a-entity id="registration3d" visible="true">
      <a-text value="Registro de Participante" color="#FFF" width="2.3"
              position="-1.1 1.0 0.01" align="left"></a-text>

      <!-- Campo Nombre (simulado) -->
      <a-text value="Nombre:" color="#FFF" width="2"
              position="-1.1 0.6 0.01" align="left"></a-text>
      <a-plane id="nameField" class="clickable" width="1" height="0.2" color="#555"
               position="0.0 0.6 0.01">
        <a-text id="nameFieldText" value="(Haz clic)" color="#CCC" width="1.5"
                position="-0.45 0 0.01" align="left"></a-text>
      </a-plane>

      <!-- Campo Edad (simulado) -->
      <a-text value="Edad:" color="#FFF" width="2"
              position="-1.1 0.2 0.01" align="left"></a-text>
      <a-plane id="ageField" class="clickable" width="0.6" height="0.2" color="#555"
               position="-0.2 0.2 0.01">
        <a-text id="ageFieldText" value="(Clic)" color="#CCC" width="1.5"
                position="-0.28 0 0.01" align="left"></a-text>
      </a-plane>

      <!-- Botón "Iniciar Misión" -->
      <a-plane id="startBtn3d" class="clickable" width="1.2" height="0.3" color="#007BFF"
               position="0 -0.3 0.01"
               material="shader: flat">
        <a-text value="Iniciar Misión" align="center" color="#FFF" width="1.8"
                position="-0.6 0 0.01">
        </a-text>
      </a-plane>
    </a-entity>

    <!-- 2) INTRO -->
    <a-entity id="intro3d" visible="false">
      <!-- Título / Texto -->
      <a-text id="introText3d" value="" color="#FFF" width="2.2"
              position="-1.1 0.8 0.01" align="left">
      </a-text>
      <!-- Botón "Comenzar Misión" -->
      <a-plane id="introBtn3d" class="clickable" width="1.2" height="0.3" color="#007BFF"
               position="0 -0.6 0.01"
               material="shader: flat" visible="false">
        <a-text value="Comenzar Misión" align="center" color="#FFF" width="1.8"
                position="-0.9 0 0.01">
        </a-text>
      </a-plane>
    </a-entity>

    <!-- 3) JUEGO / PREGUNTAS -->
    <a-entity id="game3d" visible="false">
      <!-- Imagen de la pregunta -->
      <a-plane id="questionImg" width="1.5" height="0.9" color="#444"
               position="0 0.4 0.01" visible="false"
               material="shader: flat; src: #skyImage">
      </a-plane>
      <!-- Texto de la pregunta -->
      <a-text id="questionText" value="" color="#FFF" width="2.2"
              position="-1.1 -0.2 0.01" align="left">
      </a-text>
      <!-- Botones Sí / No -->
      <a-plane id="btnYes" class="clickable" width="0.5" height="0.2" color="#008000"
               position="-0.4 -0.9 0.01"
               material="shader: flat">
        <a-text value="Sí" align="center" color="#FFF" width="1"
                position="-0.15 0 0.01">
        </a-text>
      </a-plane>
      <a-plane id="btnNo" class="clickable" width="0.5" height="0.2" color="#CC0000"
               position="0.4 -0.9 0.01"
               material="shader: flat">
        <a-text value="No" align="center" color="#FFF" width="1"
                position="-0.15 0 0.01">
        </a-text>
      </a-plane>
      <!-- Botón Siguiente -->
      <a-plane id="nextBtn3d" class="clickable" width="1.0" height="0.3" color="#007BFF"
               position="0 -0.4 0.01"
               material="shader: flat" visible="false">
        <a-text id="nextBtn3dText" value="Siguiente" align="center" color="#FFF" width="1.5"
                position="-0.7 0 0.01">
        </a-text>
      </a-plane>
    </a-entity>

    <!-- 4) PANTALLA FINAL -->
    <a-entity id="final3d" visible="false">
      <a-text id="finalTitle" value="Misión cumplida" color="#FFF" width="2.2"
              position="-1.1 0.8 0.01" align="left">
      </a-text>
      <a-text id="finalMsg" value="" color="#FFF" width="2.2"
              position="-1.1 0.3 0.01" align="left">
      </a-text>
      <!-- Imagen final (opcional) -->
      <a-plane id="finalImg" width="1.5" height="0.9" color="#444"
               position="0 -0.3 0.01" visible="true"
               material="shader: flat; src: #skyImage">
      </a-plane>
    </a-entity>

  </a-entity>
</a-scene>

<script>
/***************************************
 * Lógica de la experiencia en 3D
 ***************************************/
document.addEventListener('DOMContentLoaded', () => {
  // Referencias a entidades 3D
  const registration3d = document.getElementById('registration3d');
  const intro3d = document.getElementById('intro3d');
  const game3d = document.getElementById('game3d');
  const final3d = document.getElementById('final3d');

  // Campos y botones del registro
  const nameField = document.getElementById('nameField');
  const ageField = document.getElementById('ageField');
  const nameFieldText = document.getElementById('nameFieldText');
  const ageFieldText = document.getElementById('ageFieldText');
  const startBtn3d = document.getElementById('startBtn3d');

  // Intro
  const introText3d = document.getElementById('introText3d');
  const introBtn3d = document.getElementById('introBtn3d');

  // Juego / Preguntas
  const questionImg = document.getElementById('questionImg');
  const questionText = document.getElementById('questionText');
  const btnYes = document.getElementById('btnYes');
  const btnNo = document.getElementById('btnNo');
  const nextBtn3d = document.getElementById('nextBtn3d');
  const nextBtn3dText = document.getElementById('nextBtn3dText');

  // Final
  const finalTitle = document.getElementById('finalTitle');
  const finalMsg = document.getElementById('finalMsg');

  // Audios
  const bgMusic = document.getElementById('bgMusicAsset');
  const correctSound = document.getElementById('correctSoundAsset');
  const wrongSound = document.getElementById('wrongSoundAsset');
  const clickSound = document.getElementById('clickSoundAsset');
  const introAudio = document.getElementById('introAsset');
  // Podrías cargar más audios para cada pregunta/nivel si quieres

  // Estado del juego y datos del jugador
  let player = { name: "", age: "", date: "" };
  let currentQuestionIndex = 0;
  let currentLevel = 1;
  let totalScore = 0;
  let attemptsForCurrentQuestion = 0;

  // Narrativa general de introducción
  const generalIntro = `¡Hola, valiente explorador/a! 
Hoy has sido elegido/a para una misión muy especial: convertirte en un agente de la Brigada Protectora.
Nuestra tarea es reconocer situaciones de violencia y proteger a todos los niños y niñas del mundo.
¡Ponte tu lupa, prepárate y que comience la aventura!`;

  // Narrativas por nivel
  const levelNarratives = {
    1: {
      text: `Nivel 1: ¿Qué son las violencias basadas en género?
Antes de empezar...
Las violencias basadas en género ocurren cuando alguien trata mal a otra persona solo por ser niño o niña. 
Esto puede hacer que alguien se sienta triste.`,
      audio: "audio/level1_narration.mp3",
      image: "images/level1_intro.webp"
    },
    2: {
      text: `Nivel 2: ¿Cómo saber si algo no está bien?
A veces, algo nos hace sentir mal, pero no sabemos si es correcto. 
Algunas señales son: tocamientos no deseados, obligaciones forzadas, palabras hirientes o trato desigual.`,
      audio: "audio/level2_narration.mp3",
      image: "images/level2_intro.webp"
    },
    3: {
      text: `Nivel 3: ¿Qué hacer si esto te sucede a ti o a alguien que conoces?
Si notas que alguien sufre maltrato, recuerda: 
habla con una persona de confianza, no es tu culpa y siempre hay ayuda disponible.`,
      audio: "audio/level3_narration.mp3",
      image: "images/level3_intro.webp"
    }
  };

  // Preguntas
  const questions = [
    { level: 1, question: `Situación 1:
Mariana quiere jugar fútbol, pero unos niños le dicen que el fútbol es "solo para niños". 
¿Hay violencia? (Sí / No)`, correct: "Sí", feedback: `Decirle a alguien que no puede hacer algo por su género es discriminatorio.`, image: "images/nivel1_situacion1.webp" },
    { level: 1, question: `Situación 2:
Pedro quiere aprender a bailar, pero sus amigos se burlan y dicen que "bailar es cosa de niñas". 
¿Hay violencia? (Sí / No)`, correct: "Sí", feedback: `Burlarse de los gustos de alguien es violencia.`, image: "images/nivel1_situacion2.webp" },
    { level: 1, question: `Situación 3:
En la escuela se organizan equipos de ciencias y todos pueden participar. 
¿Hay violencia? (Sí / No)`, correct: "No", feedback: `¡Correcto!`, image: "images/nivel1_situacion3.webp" },
    { level: 2, question: `Situación 1:
A Juan le dicen "cuatro ojos" por usar gafas. 
¿Hay violencia? (Sí / No)`, correct: "Sí", feedback: `Burlarse por la apariencia es violencia.`, image: "images/nivel2_situacion1.webp" },
    { level: 2, question: `Situación 2:
Sara no quiere abrazar a un familiar, pero su mamá la obliga. 
¿Hay violencia? (Sí / No)`, correct: "Sí", feedback: `Nadie debe obligarte a hacer algo que no deseas.`, image: "images/nivel2_situacion2.webp" },
    { level: 2, question: `Situación 3:
David es nuevo y todos lo incluyen en juegos. 
¿Hay violencia? (Sí / No)`, correct: "No", feedback: `¡Correcto!`, image: "images/nivel2_situacion3.webp" },
    { level: 3, question: `Situación 1:
Lucía observa que su amiga está triste por ser molestada. 
¿Debería ayudarla? (Sí / No)`, correct: "Sí", feedback: `¡Exacto!`, image: "images/nivel3_situacion1.webp" },
    { level: 3, question: `Situación 2:
Carlos escucha que a un niño se le advierte que "si cuenta algo, tendrá problemas". 
¿Debería hablar con un adulto? (Sí / No)`, correct: "Sí", feedback: `¡Muy bien!`, image: "images/nivel3_situacion2.webp" },
    { level: 3, question: `Situación 3:
Emilia decide no contar un problema pensando que nadie le creerá. 
¿Debería buscar ayuda? (Sí / No)`, correct: "Sí", feedback: `¡Correcto!`, image: "images/nivel3_situacion3.webp" }
  ];

  /*****************************************************
   * Funciones de apoyo
   *****************************************************/
  function showEntity(entity, show = true) {
    entity.setAttribute('visible', show);
  }

  function setText(aTextEl, text) {
    aTextEl.setAttribute('value', text);
  }

  function playAudio(el) {
    el.currentTime = 0;
    el.play();
  }

  // Alertas en pantalla (HTML) para puntaje y feedback
  function showScoreAlert(points) {
    let alertDiv = document.createElement('div');
    alertDiv.className = "score-alert";
    alertDiv.textContent = `¡Ganaste ${points} pts!`;
    document.body.appendChild(alertDiv);
    setTimeout(() => alertDiv.remove(), 3000);
  }
  function showFeedbackAlert(message) {
    let feedbackDiv = document.createElement('div');
    feedbackDiv.className = "feedback-alert";
    feedbackDiv.innerHTML = message;
    document.body.appendChild(feedbackDiv);
    setTimeout(() => feedbackDiv.remove(), 5000);
  }

  // Simulamos captura de Nombre y Edad en VR
  nameField.addEventListener('click', () => {
    playAudio(clickSound);
    player.name = "AgenteX";
    setText(nameFieldText, player.name);
  });
  ageField.addEventListener('click', () => {
    playAudio(clickSound);
    player.age = "10";
    setText(ageFieldText, player.age);
  });

  // Botón Iniciar Misión (3D)
  startBtn3d.addEventListener('click', () => {
    playAudio(clickSound);
    if (!player.name || !player.age) {
      alert("Por favor, ingresa Nombre y Edad (simulado) antes de iniciar.");
      return;
    }
    // Registramos la fecha
    player.date = new Date().toLocaleString();
    // Iniciamos música de fondo y audio de intro
    playAudio(bgMusic);
    playAudio(introAudio);
    // Ocultar registro, mostrar intro
    showEntity(registration3d, false);
    showEntity(intro3d, true);
    setText(introText3d, generalIntro);
    // Al cabo de unos segundos, mostramos el botón "Comenzar Misión"
    setTimeout(() => {
      showEntity(introBtn3d, true);
    }, 3000);
  });

  // Botón "Comenzar Misión" en intro
  introBtn3d.addEventListener('click', () => {
    playAudio(clickSound);
    showEntity(intro3d, false);
    startLevelNarrative(currentLevel);
  });

  // Manejo de la narrativa de inicio de nivel
  function startLevelNarrative(level) {
    console.log("Iniciando nivel:", level);
    showEntity(game3d, false);
    showEntity(intro3d, true);
    showEntity(introBtn3d, false);
    attemptsForCurrentQuestion = 0;

    // Ponemos el texto de la narrativa
    setText(introText3d, levelNarratives[level].text);
    // Reproducir audio narración (opcional)
    let narrationAudio = new Audio(levelNarratives[level].audio);
    playAudio(narrationAudio);

    // Mostrar botón "Continuar" tras un tiempo
    setTimeout(() => {
      showEntity(introBtn3d, true);
      setText(introBtn3d.querySelector('a-text'), "Continuar");
      // Al hacer clic en "Continuar" vamos a showQuestion
      introBtn3d.onclick = () => {
        playAudio(clickSound);
        showEntity(intro3d, false);
        showEntity(game3d, true);
        showQuestion();
      };
    }, 4000);
  }

  // Mostramos pregunta actual
  function showQuestion() {
    if (currentQuestionIndex >= questions.length) {
      // Ya no hay más preguntas: pantalla final
      showEntity(game3d, false);
      showEntity(final3d, true);
      setText(finalMsg, `Felicidades, Agente ${player.name}.\nScore Final: ${totalScore} pts\n¡Gracias por jugar!`);
      let finalAudio = new Audio("audio/final.mp3");
      playAudio(finalAudio);
      sendResultToBackend();
      return;
    }
    let q = questions[currentQuestionIndex];
    // Si el nivel de la pregunta > currentLevel, pasamos a narrativa
    if (q.level > currentLevel) {
      setText(questionText, `¡Felicidades! Completaste el nivel ${currentLevel}.\nPulsa "Siguiente" para continuar...`);
      showEntity(nextBtn3d, true);
      setText(nextBtn3dText, "Siguiente Nivel");
      nextBtn3d.onclick = () => {
        playAudio(clickSound);
        currentLevel = q.level;
        showEntity(nextBtn3d, false);
        startLevelNarrative(currentLevel);
      };
      return;
    }
    // Mostramos la pregunta
    attemptsForCurrentQuestion = 0;
    showEntity(nextBtn3d, false);
    setText(nextBtn3dText, "Siguiente");
    // Imagen
    questionImg.setAttribute('src', q.image);
    showEntity(questionImg, true);
    // Texto
    setText(questionText, q.question);
  }

  // Botones Sí / No
  btnYes.addEventListener('click', () => checkAnswer("Sí"));
  btnNo.addEventListener('click', () => checkAnswer("No"));

  function checkAnswer(answer) {
    playAudio(clickSound);
    let q = questions[currentQuestionIndex];
    if (answer === q.correct) {
      playAudio(correctSound);
      let basePoints = (q.level === 1) ? 5 : (q.level === 2 ? 10 : 15);
      let pointsAwarded = (attemptsForCurrentQuestion > 0) 
                          ? Math.round(basePoints * 0.7) 
                          : basePoints;
      totalScore += pointsAwarded;
      showScoreAlert(pointsAwarded);
      showFeedbackAlert(`✅ ${q.feedback}`);
      // Mostrar botón "Siguiente"
      showEntity(nextBtn3d, true);
      nextBtn3d.onclick = () => {
        playAudio(clickSound);
        currentQuestionIndex++;
        showQuestion();
      };
    } else {
      playAudio(wrongSound);
      attemptsForCurrentQuestion++;
      showFeedbackAlert("❌ Respuesta incorrecta. Intenta de nuevo.");
    }
  }

  // Enviar resultados al backend
  function sendResultToBackend() {
    const data = {
      nombre: player.name,
      edad: player.age,
      fecha: player.date,
      scoreFinal: totalScore
    };
    fetch('/guardar_resultado', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify(data)
    })
    .then(r => r.text())
    .then(d => console.log("Resultado guardado:", d))
    .catch(e => console.error("Error:", e));
  }

  // Reproducir clickSound en cada clic de botón
  document.addEventListener('click', (ev) => {
    let tag = ev.target.tagName.toLowerCase();
    if (tag === 'a-plane' || tag === 'a-entity' || tag === 'a-text') {
      // Revisa si es clickable
      // (a-plane con class="clickable" dispara el evento, pero para no duplicar
      //  se hace un condicional más estricto si quieres)
      // playAudio(clickSound); // ya lo hacemos en checkAnswer, etc.
    }
  });
});
</script>
</body>
</html>

